# 客户端（Agents）

客户端（Agent）用于让 Bastion 在其他机器上运行备份任务。本页介绍接入与日常管理。

## 接入

1. 在 Web UI：进入 **客户端** → **创建接入令牌**
2. 在目标机器：启动客户端并传入 `--enroll-token <token>`

接入令牌默认 1 小时过期，也可以限制可用次数。请将其视为敏感信息妥善保管。

示例：

```bash
./bastion agent \
  --hub-url http://127.0.0.1:9876 \
  --enroll-token <token> \
  --name "<friendly-name>"
```

说明：

- 客户端会将接入身份信息保存在自身的数据目录中（`--data-dir` / `BASTION_DATA_DIR`）。
- 如果客户端已经接入过，则不需要 `--enroll-token`。

## 状态与生命周期

客户端可能处于以下状态：

- **在线**：最近有连接
- **离线**：当前未连接（部分操作会排队，等重新连接后再执行）
- **已撤销**：已被管理员撤销，应视为不可信

在客户端详情中，可以查看配置同步状态与最近错误。

## 标签

你可以给客户端添加任意标签（例如 `prod`、`cn`、`db`）。

标签的使用场景：

- **客户端列表筛选**：按标签过滤客户端（支持 AND/OR 模式）
- **批量操作选择器**：按标签选择目标客户端

常见标签模式：

- 环境：`prod`、`staging`、`dev`
- 地域：`cn`、`us`、`eu`
- 角色：`db`、`web`、`media`

## 配置同步（状态与操作）

Hub 会为每个客户端生成一份 **配置快照**（config snapshot），包含该客户端需要的备份任务、凭据与运行相关配置。
客户端在线时会拉取并应用这份快照。

在客户端详情中会显示：

- **目标快照 ID**：Hub 希望客户端下一次应用的快照
- **已应用快照 ID**：客户端上一次上报已应用的快照
- **错误摘要**：最近一次同步错误（类型/消息/时间）

可用动作：

- **立即同步**（单个客户端）：请求该客户端尽快拉取并应用最新配置
- **同步配置**（批量）：对多个客户端发起同步请求（批量操作）

注意：

- 若客户端离线，同步请求会被记录，待其重新连接后再投递。
- 批量操作的进度可在 **设置 → 批量操作** 中查看。

## 安全相关动作（轮换密钥 / 撤销）

### 轮换客户端密钥

轮换会为同一个客户端 ID 生成新的密钥。

建议流程：

1. 在客户端详情页点击 **轮换客户端密钥**
2. 复制 UI 展示的新密钥（只会展示一次）
3. 在客户端机器上更新数据目录中的 `agent.json`（替换为新密钥）
4. 重启客户端进程

### 撤销客户端

撤销会在 Hub 侧将该客户端标记为已撤销。

如果你希望重新接入该机器，请把它当作新机器重新接入：

- 清空该客户端的数据目录（或至少删除 `agent.json`）
- 重新创建接入令牌并 enroll
