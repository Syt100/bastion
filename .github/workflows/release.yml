name: Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    name: build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    env:
      # For workflow_dispatch (branch refs), use a safe placeholder version for packaging steps that require semver.
      BASTION_VERSION: ${{ github.ref_type == 'tag' && github.ref_name || 'v0.0.0' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            cargo_target: ""
            asset_ext: tar.gz
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            cargo_target: x86_64-unknown-linux-musl
            asset_ext: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            cargo_target: ""
            asset_ext: zip
          - os: macos-15-intel
            target: x86_64-apple-darwin
            cargo_target: ""
            asset_ext: tar.gz
          - os: macos-latest
            target: aarch64-apple-darwin
            cargo_target: ""
            asset_ext: tar.gz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20.19.0"
          cache: "npm"
          cache-dependency-path: |
            ui/package-lock.json
            docs/package-lock.json

      - name: Build UI (for embed-ui)
        run: |
          npm ci --prefix ui
          npm run build-only --prefix ui

      - name: Build docs (for embed-docs)
        env:
          DOCS_BASE: /docs/
        run: |
          npm ci --prefix docs
          npm run build --prefix docs

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Setup musl (Linux)
        if: runner.os == 'Linux' && matrix.cargo_target == 'x86_64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools
          rustup target add x86_64-unknown-linux-musl

      - name: Build (release, embed-web)
        if: matrix.cargo_target == ''
        run: cargo build -p bastion --release --locked --features embed-web

      - name: Build (release, embed-web, cross-target)
        if: matrix.cargo_target != ''
        run: cargo build -p bastion --release --locked --features embed-web --target ${{ matrix.cargo_target }}

      - name: Package (Linux)
        if: runner.os == 'Linux'
        run: |
          asset="bastion-${{ github.ref_name }}-${{ matrix.target }}.tar.gz"
          bin_dir="target/release"
          if [ -n "${{ matrix.cargo_target }}" ]; then
            bin_dir="target/${{ matrix.cargo_target }}/release"
          fi
          tar -C "${bin_dir}" -czf "${asset}" bastion

      - name: Cache cargo packagers (Linux)
        if: runner.os == 'Linux' && matrix.target == 'x86_64-unknown-linux-gnu'
        uses: actions/cache@v4
        with:
          path: ~/.cache/bastion-tools/cargo
          key: ${{ runner.os }}-bastion-cargo-packagers-cargo-deb-3.6.2-cargo-generate-rpm-0.20.0

      - name: Package (Linux .deb/.rpm)
        if: runner.os == 'Linux' && matrix.target == 'x86_64-unknown-linux-gnu'
        run: |
          set -euo pipefail

          version="${BASTION_VERSION#v}"
          if [[ ! "${version}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
            version="0.0.0"
          fi

          tools_root="${HOME}/.cache/bastion-tools/cargo"
          export PATH="${tools_root}/bin:${PATH}"

          # Install packagers once (cached across workflow runs).
          if [ ! -x "${tools_root}/bin/cargo-deb" ]; then
            cargo install cargo-deb --locked --version 3.6.2 --root "${tools_root}"
          fi
          if [ ! -x "${tools_root}/bin/cargo-generate-rpm" ]; then
            cargo install cargo-generate-rpm --locked --version 0.20.0 --root "${tools_root}"
          fi

          # Debian package (binary-only).
          cargo deb -p bastion \
            --no-build \
            --no-strip \
            --deb-version "${version}" \
            --output target/debian \
            -- \
            --locked \
            --features embed-web
          deb="$(ls -1 target/debian/*.deb | head -n 1)"
          cp "${deb}" "bastion-${{ github.ref_name }}-${{ matrix.target }}.deb"

          # RPM package (binary-only). Run from the package directory because the repo root is a workspace manifest.
          (cd crates/bastion && cargo generate-rpm --auto-req builtin --output "../../bastion-${{ github.ref_name }}-${{ matrix.target }}.rpm")

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $asset = "bastion-${{ github.ref_name }}-${{ matrix.target }}.zip"
          Compress-Archive -Path "target\\release\\bastion.exe" -DestinationPath $asset -Force

      - name: Package (Windows MSI)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # WiX Toolset v3 (candle/light) via Chocolatey.
          choco install wixtoolset -y --no-progress

          $version = $env:BASTION_VERSION
          if (-not $version) { $version = "0.0.0" }
          $version = $version -replace '^v',''
          if ($version -notmatch '^\d+\.\d+\.\d+(\.\d+)?$') {
            $version = "0.0.0"
          }
          if ($version -match '^\d+\.\d+\.\d+$') {
            # WiX expects the Product/@Version value in x.x.x.x form.
            $version = "$version.0"
          }

          $wixObj = "bastion.wixobj"
          & candle.exe `
            -nologo `
            -out $wixObj `
            "-dProductVersion=$version" `
            "-dSourceDir=target\\release" `
            "packaging\\windows\\bastion.wxs"

          $asset = "bastion-${{ github.ref_name }}-${{ matrix.target }}.msi"
          & light.exe -nologo -o $asset $wixObj

      - name: Package (macOS)
        if: runner.os == 'macOS'
        run: |
          asset="bastion-${{ github.ref_name }}-${{ matrix.target }}.tar.gz"
          tar -C target/release -czf "${asset}" bastion

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bastion-${{ matrix.target }}
          path: bastion-${{ github.ref_name }}-${{ matrix.target }}.*
          if-no-files-found: error

  release:
    name: publish
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Checkout (for release notes)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Generate SHA256 checksums
        run: |
          set -euo pipefail
          (cd dist && sha256sum * > sha256sums.txt)

      - name: Generate release notes
        run: |
          set -euo pipefail

          tag="${GITHUB_REF_NAME}"
          repo="${GITHUB_REPOSITORY}"

          prev_tag="$(git describe --tags --match 'v*' --abbrev=0 "${tag}^" 2>/dev/null || true)"
          if [ -n "${prev_tag}" ]; then
            range="${prev_tag}..${tag}"
            compare_url="https://github.com/${repo}/compare/${prev_tag}...${tag}"
          else
            range="${tag}"
            compare_url="https://github.com/${repo}/commits/${tag}"
          fi

          changes="$(git log --no-merges --pretty=format:'- %s (%h)' "${range}" || true)"
          if [ -z "${changes}" ]; then
            changes="- No changes."
          fi

          {
            echo "## Changes"
            echo
            echo "${changes}"
            echo
            echo "**Full Changelog**: ${compare_url}"
          } > release-notes.md

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          body_path: release-notes.md
